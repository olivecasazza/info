name: Build and Deploy

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  R2_BUCKET: info-assets
  R2_PUBLIC_URL: https://info-assets.casazza.info

jobs:
  build:
    runs-on: ubuntu-latest
    environment: cloudflare
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes

      # Cache Nix store with Cachix
      - name: Setup Cachix
        uses: cachix/cachix-action@v15
        with:
          name: info
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'

      # Build WASM packages separately first
      - name: Build WASM packages
        run: |
          echo "Building WASM packages..."
          nix build .#flock-wasm-pkg .#pipedream-wasm-pkg .#spot-wasm-pkg --no-link
          echo "WASM packages built successfully"

      # Sync WASM to wasm/*/pkg directories
      - name: Sync WASM packages
        run: nix run .#sync-wasm

      # Verify WASM files exist
      - name: Verify WASM sync
        run: |
          echo "=== Checking WASM pkg directories ==="
          ls -la wasm/flock/pkg/ || echo "flock/pkg missing!"
          ls -la wasm/pipedream/pkg/ || echo "pipedream/pkg missing!"
          ls -la wasm/spot/pkg/ || echo "spot/pkg missing!"

      # Install npm dependencies
      - name: Install npm dependencies
        run: |
          export npm_config_cache="$PWD/.npm-cache"
          npm ci

      # Generate static site
      - name: Generate static site
        run: |
          export npm_config_cache="$PWD/.npm-cache"
          npx nuxt generate
          touch .output/public/.nojekyll

      - name: Show WASM sizes
        run: |
          echo "=== WASM file sizes ==="
          ls -lh .output/public/_nuxt/*.wasm 2>/dev/null || echo "No WASM files found"

      - name: Upload WASM to R2
        if: github.ref == 'refs/heads/main'
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: |
            r2 object put ${{ env.R2_BUCKET }}/_nuxt/$(ls .output/public/_nuxt/flock_bg.*.wasm | xargs basename) --file "$(ls .output/public/_nuxt/flock_bg.*.wasm)" --content-type application/wasm;
            r2 object put ${{ env.R2_BUCKET }}/_nuxt/$(ls .output/public/_nuxt/pipedream_bg.*.wasm | xargs basename) --file "$(ls .output/public/_nuxt/pipedream_bg.*.wasm)" --content-type application/wasm;
            r2 object put ${{ env.R2_BUCKET }}/_nuxt/$(ls .output/public/_nuxt/spot_bg.*.wasm | xargs basename) --file "$(ls .output/public/_nuxt/spot_bg.*.wasm)" --content-type application/wasm

      - name: Create _redirects for WASM
        if: github.ref == 'refs/heads/main'
        run: |
          cat >> .output/public/_redirects << EOF
          # Serve WASM from R2 CDN
          /_nuxt/*.wasm ${{ env.R2_PUBLIC_URL }}/_nuxt/:splat 200
          EOF
          echo "Created _redirects:"
          cat .output/public/_redirects

      - name: Remove WASM from Pages bundle
        if: github.ref == 'refs/heads/main'
        run: |
          rm -f .output/public/_nuxt/*.wasm
          echo "WASM removed from Pages (served from R2)"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: site-build
          path: .output/public
          retention-days: 1

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment: cloudflare
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: read
      deployments: write
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: site-build
          path: .output/public

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy .output/public --project-name=info
