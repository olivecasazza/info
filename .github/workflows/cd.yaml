name: Build and Deploy

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  R2_BUCKET: info-assets
  # Set this to your R2 public domain after setup
  R2_PUBLIC_URL: https://pub-info-assets.r2.dev

jobs:
  build:
    runs-on: ubuntu-latest
    environment: cloudflare
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Cache Nix store
        uses: cachix/cachix-action@v15
        with:
          name: nix-community
          skipPush: true

      - name: Build with Nix
        run: nix run .#build-pages

      - name: Show WASM sizes
        run: |
          echo "=== WASM file sizes ==="
          ls -lh .output/public/_nuxt/*.wasm 2>/dev/null || echo "No WASM files found"

      - name: Upload all WASM to R2
        if: github.ref == 'refs/heads/main'
        run: |
          # Upload each WASM file to R2 with its hashed filename
          for wasm in .output/public/_nuxt/*.wasm; do
            [ -f "$wasm" ] || continue
            filename=$(basename "$wasm")
            echo "Uploading $filename to R2..."
          done
        # Note: actual upload happens in next step

      - name: Upload WASM to R2
        if: github.ref == 'refs/heads/main'
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: |
            r2 object put ${{ env.R2_BUCKET }}/_nuxt/$(ls .output/public/_nuxt/flock_bg.*.wasm | xargs basename) --file "$(ls .output/public/_nuxt/flock_bg.*.wasm)" --content-type application/wasm;
            r2 object put ${{ env.R2_BUCKET }}/_nuxt/$(ls .output/public/_nuxt/pipedream_bg.*.wasm | xargs basename) --file "$(ls .output/public/_nuxt/pipedream_bg.*.wasm)" --content-type application/wasm;
            r2 object put ${{ env.R2_BUCKET }}/_nuxt/$(ls .output/public/_nuxt/spot_bg.*.wasm | xargs basename) --file "$(ls .output/public/_nuxt/spot_bg.*.wasm)" --content-type application/wasm

      - name: Create _redirects for WASM (serve from R2)
        if: github.ref == 'refs/heads/main'
        run: |
          # Cloudflare Pages _redirects: proxy WASM requests to R2
          cat >> .output/public/_redirects << 'EOF'
          # Serve WASM from R2 CDN
          /_nuxt/*.wasm ${{ env.R2_PUBLIC_URL }}/_nuxt/:splat 200
          EOF
          cat .output/public/_redirects

      - name: Remove WASM from Pages (served via redirect)
        if: github.ref == 'refs/heads/main'
        run: |
          rm -f .output/public/_nuxt/*.wasm
          echo "WASM files removed from Pages bundle (will be served from R2)"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: site-build
          path: .output/public
          retention-days: 1

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment: cloudflare
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: read
      deployments: write
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: site-build
          path: .output/public

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy .output/public --project-name=info
