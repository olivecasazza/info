name: Build and Deploy

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  R2_BUCKET: info-assets
  R2_PUBLIC_URL: https://info-assets.casazza.info

jobs:
  build:
    runs-on: ubuntu-latest
    environment: cloudflare
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes

      # Cache Nix store with Cachix
      - name: Setup Cachix
        uses: cachix/cachix-action@v15
        with:
          name: info
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'

      # Build WASM packages separately first
      - name: Build WASM packages
        run: |
          echo "Building WASM packages..."
          nix build .#flock-wasm-pkg .#pipedream-wasm-pkg .#spot-wasm-pkg --no-link
          echo "WASM packages built successfully"

      # Sync WASM to wasm/*/pkg directories
      - name: Sync WASM packages
        run: nix run .#sync-wasm

      # Verify WASM files exist
      - name: Verify WASM sync
        run: |
          echo "=== Checking WASM pkg directories ==="
          ls -la wasm/flock/pkg/ || echo "flock/pkg missing!"
          ls -la wasm/pipedream/pkg/ || echo "pipedream/pkg missing!"
          ls -la wasm/spot/pkg/ || echo "spot/pkg missing!"

      # Install npm dependencies
      - name: Install npm dependencies
        run: |
          export npm_config_cache="$PWD/.npm-cache"
          npm ci

      # Pre-copy WASM packages to node_modules (prevents vite-plugin-wasm-pack copy failures)
      - name: Pre-copy WASM to node_modules
        run: |
          for pkg in flock pipedream spot; do
            echo "=== Pre-copying wasm/$pkg/pkg to node_modules/$pkg ==="
            rm -rf "node_modules/$pkg"
            mkdir -p "node_modules/$pkg"
            # Copy with -L to follow symlinks and convert to regular files
            cp -rL "wasm/$pkg/pkg/"* "node_modules/$pkg/"
            chmod -R u+rwX "node_modules/$pkg"
            echo "Files in node_modules/$pkg:"
            ls -la "node_modules/$pkg/"
          done

      # Verify the pre-copy worked
      - name: Verify pre-copy
        run: |
          echo "=== Verifying node_modules WASM packages ==="
          for pkg in flock pipedream spot; do
            echo "--- $pkg ---"
            ls -la "node_modules/$pkg/" || echo "MISSING!"
            file "node_modules/$pkg"/*.js 2>/dev/null | head -2 || true
            file "node_modules/$pkg"/*.wasm 2>/dev/null | head -2 || true
          done

      # Generate static site
      - name: Generate static site
        run: |
          export npm_config_cache="$PWD/.npm-cache"
          echo "=== Starting nuxt generate ==="
          npx nuxt generate
          touch .output/public/.nojekyll

      - name: Show WASM sizes
        run: |
          echo "=== WASM file sizes ==="
          ls -lh .output/public/_nuxt/*.wasm 2>/dev/null || echo "No WASM files found"

      - name: Install wrangler
        if: github.ref == 'refs/heads/main'
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: whoami

      - name: Upload WASM to R2
        if: github.ref == 'refs/heads/main'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "PWD: $(pwd)"
          echo "Looking for WASM files..."
          ls -la .output/public/_nuxt/*.wasm || echo "No .wasm files in _nuxt!"
          shopt -s nullglob
          for wasm in .output/public/_nuxt/*_bg*.wasm; do
            fname=$(basename "$wasm")
            echo "Uploading $fname to R2..."
            npx wrangler r2 object put "${{ env.R2_BUCKET }}/_nuxt/$fname" --file "$wasm" --content-type application/wasm
          done

      - name: Create _redirects for WASM
        if: github.ref == 'refs/heads/main'
        run: |
          cat >> .output/public/_redirects << EOF
          # Serve WASM from R2 CDN
          /_nuxt/*.wasm ${{ env.R2_PUBLIC_URL }}/_nuxt/:splat 200
          EOF
          echo "Created _redirects:"
          cat .output/public/_redirects

      - name: Remove WASM from Pages bundle
        if: github.ref == 'refs/heads/main'
        run: |
          rm -f .output/public/_nuxt/*.wasm
          echo "WASM removed from Pages (served from R2)"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: site-build
          path: .output/public
          retention-days: 1

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment: cloudflare
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: read
      deployments: write
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: site-build
          path: .output/public

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy .output/public --project-name=info
