name: Build and Deploy

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    environment: cloudflare
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Cache Nix store
        uses: cachix/cachix-action@v15
        with:
          name: nix-community
          skipPush: true

      - name: Build with Nix
        run: nix run .#build-pages

      - name: Check WASM sizes
        id: wasm-sizes
        run: |
          SPOT_SIZE=$(stat -c%s .output/public/_nuxt/spot_bg.*.wasm 2>/dev/null || echo 0)
          echo "spot_size=$SPOT_SIZE" >> $GITHUB_OUTPUT
          echo "Spot WASM size: $((SPOT_SIZE / 1024 / 1024)) MB"

          if [ "$SPOT_SIZE" -gt 25165824 ]; then
            echo "needs_r2=true" >> $GITHUB_OUTPUT
            echo "::warning::spot_bg.wasm is over 25MB, will upload to R2"
          else
            echo "needs_r2=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload large WASM to R2
        if: steps.wasm-sizes.outputs.needs_r2 == 'true' && github.ref == 'refs/heads/main'
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: r2 object put info-assets/spot_bg.wasm --file .output/public/_nuxt/spot_bg.*.wasm

      - name: Remove large WASM for Pages
        if: steps.wasm-sizes.outputs.needs_r2 == 'true'
        run: rm -f .output/public/_nuxt/spot_bg.*.wasm

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: site-build
          path: .output/public
          retention-days: 1

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment: cloudflare
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: read
      deployments: write
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: site-build
          path: .output/public

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy .output/public --project-name=info
